{"mappings":"AAGA,OAAO,MAAM,gBAAgB,OAAO,WAwC3B,CAAC","sources":["index.ts"],"sourcesContent":["import type { CompartmentEvaluateOptions, CompartmentOptions } from 'ses'\nimport { getGlobalIntrinsics } from './node_modules/ses/src/intrinsics.js'\nconst key = 'Compartment';\nexport const UniCompartment: typeof Compartment = key in globalThis ? (globalThis as any)[key] : (class _UniCompartment {\n    static readonly #evaluatorFactory: Function = 'eval' in globalThis ? new Function('$', `with($){return a=>eval(a);}`) : '~CodeFactory' in globalThis ? ($ => (globalThis as any)['~CodeFactory'].compartment($)) : $ => { throw ``; };\n    #opts: CompartmentOptions;\n    constructor(opts: CompartmentOptions) {\n        this.#opts = opts;\n        const val = {\n            ...((() => {\n                if ('Object' in globalThis && 'freeze' in globalThis['Object']) {\n                    return getGlobalIntrinsics(globalThis, { ...console })\n                } else if ('~GetClean' in globalThis) {\n                    return (globalThis as any)['~GetClean']();\n                } else {\n                    return {}\n                }\n            })()), ...opts.globals ?? {}\n        };\n        if ('Object' in globalThis && 'freeze' in globalThis['Object']) {\n            globalThis['Object']['freeze'](val);\n        }\n        this.#scope = 'Proxy' in globalThis ? new globalThis[\"Proxy\"](val, {\n            has(target, p) {\n                return true;\n            },\n        }) : '~MakeCage' in globalThis ? (globalThis as any)['~MakeCage'](val) : val;\n    }\n    #scope: any;\n    get globalThis() {\n        return this.#scope;\n    }\n    get name() {\n        return this.#opts.name ??= ('crypto' in globalThis ? globalThis.crypto.randomUUID() : 'Math' in globalThis ? `${Math.random()}` : \"unnamed\");\n    }\n    #_evaluator: ((a: string) => any) | undefined;\n    get #evaluator(): (a: string) => any {\n        return this.#_evaluator ??= (_UniCompartment.#evaluatorFactory.call(this.#scope, this.#scope))\n    }\n    evaluate(a: string, opts?: CompartmentEvaluateOptions): any {\n        a = this.#opts.transforms?.reduce?.((i, f) => f(i), a) ?? a;\n        return this.#evaluator(a);\n    }\n}) as any;"],"names":[],"version":3,"file":"index.d.ts.map"}